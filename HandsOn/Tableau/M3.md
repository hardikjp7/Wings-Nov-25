# Module 3: Calculations and Advanced Fields - Detailed Hands-On Notes

## 1. Calculated Fields - Basics

### What is a Calculated Field?
A new field created using a formula/expression based on existing fields in your data.

### Creating Calculated Fields

**Method 1: From Data Pane**
```
Steps:
1. Right-click in Data pane (blank area)
2. Select "Create Calculated Field"
3. Name your calculation
4. Write formula in calculation editor
5. Click OK
```

**Method 2: From Analysis Menu**
```
Steps:
1. Analysis menu → Create Calculated Field
2. Follow same steps as above
```

**Method 3: Quick Calculation**
```
Steps:
1. Double-click in Rows/Columns shelf (opens calculation editor)
2. Type formula directly
3. Press Enter
```

---

### Calculation Editor Components

**Elements:**
- **Field name box:** Top (name your calculation)
- **Formula box:** Middle (write your formula)
- **Function list:** Right side (all available functions)
- **Search box:** Search functions
- **Validation status:** Bottom (shows if formula is valid)

**Status Messages:**
- ✓ "The calculation is valid" = Good to go
- ✗ "The calculation contains errors" = Fix required

---

### Basic Calculation Syntax

**Field References:**
```
[Field Name]    ← Always in square brackets
[Sales]
[Order Date]
[Customer Name]
```

**Operators:**
```
+    Addition
-    Subtraction
*    Multiplication
/    Division
^    Power/Exponent
%    Modulo (remainder)
```

**Comparison Operators:**
```
=    Equal to
!=   Not equal to
>    Greater than
<    Less than
>=   Greater than or equal
<=   Less than or equal
```

**Logical Operators:**
```
AND    Both conditions true
OR     Either condition true
NOT    Negates condition
```

---

## 2. Basic Calculated Field Examples

### A. Simple Arithmetic

**Example 1: Profit Ratio**
```
Task: Calculate profit as percentage of sales

Calculation:
[Profit] / [Sales]

Result: Decimal (0.25 = 25%)

To show as percentage:
1. Create calculation
2. Right-click field → Default Properties → Number Format
3. Select Percentage with 2 decimals
```

---

**Example 2: Discount Amount**
```
Task: Calculate actual discount amount in dollars

Calculation:
[Sales] * [Discount]

Note: Discount is already decimal (0.20 = 20% discount)
```

---

**Example 3: Total Cost**
```
Task: Calculate cost (Sales - Profit)

Calculation:
[Sales] - [Profit]

Or name it:
Name: Cost
Formula: [Sales] - [Profit]
```

---

**Example 4: Average Order Value**
```
Task: Calculate average sales per order

Calculation:
SUM([Sales]) / COUNTD([Order ID])

Note: Use SUM and COUNTD because we're aggregating
```

---

### B. Aggregation Functions

**Common Aggregations:**
```
SUM([Sales])           ← Total sales
AVG([Sales])           ← Average sales
MIN([Sales])           ← Minimum sales
MAX([Sales])           ← Maximum sales
COUNT([Order ID])      ← Count all orders
COUNTD([Customer ID])  ← Count distinct customers
MEDIAN([Sales])        ← Median sales
STDEV([Sales])         ← Standard deviation
VAR([Sales])           ← Variance
```

---

**When to Use:**

**Aggregated Calculations (AGG):**
- Use when mixing aggregated and non-aggregated fields
- When building calculations for measures

**Example:**
```
Task: Profit per order

Wrong:
[Profit] / [Order ID]    ← Can't divide measure by dimension

Correct:
SUM([Profit]) / COUNTD([Order ID])
```

---

**Row-Level Calculations:**
- No aggregation functions
- Calculated for each row of data
- Then aggregated in view

**Example:**
```
Task: Sales per unit

Calculation:
[Sales] / [Quantity]

This calculates for each row, then SUM/AVG in view
```

---

## 3. String Functions

### A. Basic String Functions

**UPPER / LOWER**
```
Task: Convert customer name to uppercase

UPPER([Customer Name])

Example:
"john smith" → "JOHN SMITH"

LOWER([Customer Name])
"JOHN SMITH" → "john smith"
```

---

**LEFT / RIGHT / MID**
```
LEFT([string], number)     ← Get leftmost characters
RIGHT([string], number)    ← Get rightmost characters  
MID([string], start, length) ← Get middle characters

Examples:

1. Get first 3 letters of product name:
LEFT([Product Name], 3)
"Staples" → "Sta"

2. Get last 4 characters of Order ID:
RIGHT([Order ID], 4)
"CA-2023-1001" → "1001"

3. Get characters 4-7:
MID([Product Name], 4, 4)
"Staples" → "ples"
```

---

**LEN**
```
Task: Get length of string

LEN([Customer Name])

Example:
"John Smith" → 10 (includes space)
```

---

**TRIM**
```
Task: Remove leading/trailing spaces

TRIM([Customer Name])

Example:
"  John Smith  " → "John Smith"
```

---

**REPLACE**
```
REPLACE([string], old_text, new_text)

Task: Replace "CA" with "California"

REPLACE([State], "CA", "California")

Example:
"CA" → "California"
```

---

**SUBSTITUTE**
```
SUBSTITUTE([string], old, new)

Task: Replace all spaces with underscores

SUBSTITUTE([Product Name], " ", "_")

Example:
"Office Chair" → "Office_Chair"
```

---

### B. String Concatenation

**Using + operator:**
```
Task: Combine First Name and Last Name

[First Name] + " " + [Last Name]

Example:
"John" + " " + "Smith" → "John Smith"
```

---

**Complex Example:**
```
Task: Create full address

[Address] + ", " + [City] + ", " + [State] + " " + [Postal Code]

Result:
"123 Main St, New York, NY 10001"
```

---

### C. CONTAINS, STARTSWITH, ENDSWITH

**CONTAINS**
```
Task: Check if product name contains "Chair"

CONTAINS([Product Name], "Chair")

Returns: TRUE or FALSE

Example:
"Office Chair" → TRUE
"Desk" → FALSE
```

---

**STARTSWITH**
```
Task: Check if customer ID starts with "CA"

STARTSWITH([Customer ID], "CA")

Example:
"CA-2023-001" → TRUE
"NY-2023-001" → FALSE
```

---

**ENDSWITH**
```
Task: Check if region ends with "Region"

ENDSWITH([Region], "Region")

Example:
"East Region" → TRUE
"East" → FALSE
```

---

### D. FIND Function

**FIND(string, substring)**
```
Task: Find position of "@" in email

FIND([Email], "@")

Returns: Position number (starts at 1)

Example:
"john@email.com" → 5
If not found → 0
```

---

**Practical Example:**
```
Task: Extract domain from email

MID([Email], FIND([Email], "@") + 1, LEN([Email]))

Explanation:
Email: "john@email.com"
FIND([Email], "@") → 5
Start from position 6 (+1)
Extract rest of string → "email.com"
```

---

### E. SPLIT Function

**SPLIT(string, delimiter, token number)**
```
Task: Split full name into first name

SPLIT([Full Name], " ", 1)

Example:
"John Smith" → "John"

SPLIT([Full Name], " ", 2) → "Smith"
```

---

**Practical Example:**
```
Task: Extract Order ID components

Order ID: "CA-2023-1001"

Region Code:
SPLIT([Order ID], "-", 1) → "CA"

Year:
SPLIT([Order ID], "-", 2) → "2023"

Order Number:
SPLIT([Order ID], "-", 3) → "1001"
```

---

## 4. Date Functions

### A. Date Parts

**YEAR / QUARTER / MONTH / DAY**
```
YEAR([Order Date])        ← Returns year (2023)
QUARTER([Order Date])     ← Returns quarter (1, 2, 3, 4)
MONTH([Order Date])       ← Returns month number (1-12)
DAY([Order Date])         ← Returns day (1-31)

Examples:
Date: 3/15/2023

YEAR([Order Date]) → 2023
QUARTER([Order Date]) → 1
MONTH([Order Date]) → 3
DAY([Order Date]) → 15
```

---

**WEEK / WEEKDAY**
```
WEEK([Order Date])        ← Week number of year (1-52)
WEEKDAY([Order Date])     ← Day of week (1=Sunday, 7=Saturday)

Task: Get day name
DATENAME('weekday', [Order Date])
Result: "Monday", "Tuesday", etc.
```

---

**DATEPART**
```
DATEPART('date_part', [date])

Date parts:
'year', 'quarter', 'month', 'week', 'day'
'hour', 'minute', 'second'

Examples:
DATEPART('year', [Order Date]) → 2023
DATEPART('quarter', [Order Date]) → 1
DATEPART('month', [Order Date]) → 3
```

---

### B. DATENAME

**DATENAME('date_part', [date])**
```
Returns string name instead of number

DATENAME('month', [Order Date])
Result: "January", "February", etc.

DATENAME('weekday', [Order Date])
Result: "Monday", "Tuesday", etc.

DATENAME('quarter', [Order Date])
Result: "Quarter 1", "Quarter 2", etc.
```

---

**Practical Example:**
```
Task: Create Month-Year label

DATENAME('month', [Order Date]) + " " + STR(YEAR([Order Date]))

Result: "March 2023"

Note: STR() converts number to string
```

---

### C. Date Arithmetic

**Adding/Subtracting Days:**
```
DATEADD('day', number, [date])

Task: Get date 7 days after order

DATEADD('day', 7, [Order Date])

Example:
Order Date: 3/15/2023
Result: 3/22/2023

Subtract days (use negative):
DATEADD('day', -7, [Order Date]) → 3/8/2023
```

---

**DATEADD with other intervals:**
```
DATEADD('month', 3, [Order Date])    ← Add 3 months
DATEADD('year', 1, [Order Date])     ← Add 1 year
DATEADD('week', 2, [Order Date])     ← Add 2 weeks
DATEADD('hour', 24, [Order Date])    ← Add 24 hours
```

---

**DATEDIFF**
```
DATEDIFF('date_part', start_date, end_date)

Task: Calculate days between order and ship

DATEDIFF('day', [Order Date], [Ship Date])

Example:
Order: 3/15/2023
Ship: 3/20/2023
Result: 5 days
```

---

**DATEDIFF Examples:**
```
Days difference:
DATEDIFF('day', [Order Date], [Ship Date])

Months difference:
DATEDIFF('month', [Order Date], TODAY())

Years difference (age calculation):
DATEDIFF('year', [Birth Date], TODAY())
```

---

### D. TODAY, NOW, DATE

**TODAY()**
```
Returns current date (no time)

TODAY() → 11/23/2024
```

---

**NOW()**
```
Returns current date and time

NOW() → 11/23/2024 2:30:45 PM
```

---

**DATE()**
```
Creates date from components

DATE(year, month, day)

Task: Create specific date

DATE(2023, 12, 25) → 12/25/2023
```

---

**Practical Examples:**

**1. Days since order:**
```
DATEDIFF('day', [Order Date], TODAY())
```

**2. Is order recent (last 30 days)?**
```
DATEDIFF('day', [Order Date], TODAY()) <= 30
```

**3. Age of customer:**
```
DATEDIFF('year', [Birth Date], TODAY())
```

**4. Format custom date:**
```
STR(MONTH([Order Date])) + "/" + STR(DAY([Order Date])) + "/" + STR(YEAR([Order Date]))
```

---

### E. MAKEDATE / MAKEDATETIME

**MAKEDATE(year, month, day)**
```
Task: Create date from separate fields

MAKEDATE([Year], [Month], [Day])

Example:
Year: 2023, Month: 3, Day: 15
Result: 3/15/2023
```

---

**MAKEDATETIME(date, time)**
```
Combines date and time

MAKEDATETIME([Order Date], [Order Time])
```

---

## 5. Logical Functions

### A. IF Statement

**Basic Syntax:**
```
IF condition THEN value1
ELSE value2
END

or

IF condition THEN value1
ELSEIF condition2 THEN value2
ELSE value3
END
```

---

**Example 1: Simple IF**
```
Task: Label high/low sales

IF [Sales] > 1000 THEN "High"
ELSE "Low"
END

Result:
Sales = 1500 → "High"
Sales = 500 → "Low"
```

---

**Example 2: Multiple Conditions (ELSEIF)**
```
Task: Categorize sales performance

IF [Sales] >= 1000 THEN "High"
ELSEIF [Sales] >= 500 THEN "Medium"
ELSE "Low"
END

Result:
Sales = 1500 → "High"
Sales = 750 → "Medium"
Sales = 200 → "Low"
```

---

**Example 3: Nested IF**
```
Task: Sales category by region

IF [Region] = "West" THEN
    IF [Sales] > 1000 THEN "West-High"
    ELSE "West-Low"
    END
ELSE "Other"
END
```

---

**Example 4: Multiple AND conditions**
```
Task: Identify profitable large orders

IF [Sales] > 1000 AND [Profit] > 100 THEN "Target Order"
ELSE "Regular Order"
END
```

---

**Example 5: OR conditions**
```
Task: Flag furniture or technology

IF [Category] = "Furniture" OR [Category] = "Technology" THEN "Focus Category"
ELSE "Other"
END
```

---

### B. CASE Statement

**Syntax:**
```
CASE [Field]
WHEN value1 THEN result1
WHEN value2 THEN result2
ELSE default_result
END
```

**Better for multiple exact matches than multiple ELSEIF**

---

**Example 1: Region abbreviations**
```
Task: Convert region to codes

CASE [Region]
WHEN "East" THEN "E"
WHEN "West" THEN "W"
WHEN "North" THEN "N"
WHEN "South" THEN "S"
ELSE "Unknown"
END
```

---

**Example 2: Month to Quarter**
```
Task: Convert month number to quarter

CASE 
WHEN MONTH([Order Date]) IN (1, 2, 3) THEN "Q1"
WHEN MONTH([Order Date]) IN (4, 5, 6) THEN "Q2"
WHEN MONTH([Order Date]) IN (7, 8, 9) THEN "Q3"
WHEN MONTH([Order Date]) IN (10, 11, 12) THEN "Q4"
END
```

---

**Example 3: Grade calculation**
```
Task: Assign grade based on profit ratio

CASE
WHEN [Profit]/[Sales] >= 0.30 THEN "A"
WHEN [Profit]/[Sales] >= 0.20 THEN "B"
WHEN [Profit]/[Sales] >= 0.10 THEN "C"
ELSE "D"
END
```

---

### C. IIF (Inline IF)

**Syntax:**
```
IIF(condition, true_value, false_value)

Shorter version of IF-THEN-ELSE for simple conditions
```

---

**Example 1: Profit status**
```
Task: Label profit/loss

IIF([Profit] > 0, "Profit", "Loss")

Equivalent to:
IF [Profit] > 0 THEN "Profit"
ELSE "Loss"
END
```

---

**Example 2: Discount flag**
```
IIF([Discount] > 0, "Discounted", "Full Price")
```

---

**Example 3: Nested IIF (not recommended, hard to read)**
```
IIF([Sales] > 1000, "High", IIF([Sales] > 500, "Medium", "Low"))

Better to use IF-ELSEIF for this
```

---

### D. ISNULL / IFNULL / ZN

**ISNULL(expression)**
```
Returns TRUE if value is NULL

Task: Check for missing data

ISNULL([Ship Date])

Returns: TRUE or FALSE
```

---

**IFNULL(expression, replacement)**
```
Replace NULL with specified value

Task: Replace null profit with 0

IFNULL([Profit], 0)

Example:
Profit = 100 → 100
Profit = NULL → 0
```

---

**ZN(expression)**
```
Zero if Null - shorthand for IFNULL(expr, 0)

ZN([Profit])

Same as: IFNULL([Profit], 0)
```

---

**Practical Example:**
```
Task: Calculate profit ratio handling nulls

ZN([Profit]) / IFNULL([Sales], 1)

Explanation:
- If Profit is null → 0
- If Sales is null → 1 (avoid division by zero)
- Otherwise calculate normally
```

---

### E. IN Operator

**Syntax:**
```
[Field] IN (value1, value2, value3, ...)
```

---

**Example 1: Filter specific categories**
```
Task: Check if category is furniture or technology

[Category] IN ("Furniture", "Technology")

Returns: TRUE or FALSE
```

---

**Example 2: Within IF statement**
```
Task: Label focus products

IF [Category] IN ("Furniture", "Technology") THEN "Focus"
ELSE "Other"
END
```

---

**Example 3: Multiple values**
```
Task: Flag specific states

IF [State] IN ("CA", "NY", "TX", "FL") THEN "Key State"
ELSE "Other State"
END
```

---

## 6. Aggregate Functions (Advanced)

### A. COUNTD (Count Distinct)

**Syntax:**
```
COUNTD([Field])

Counts unique values
```

---

**Examples:**
```
1. Count unique customers:
COUNTD([Customer ID])

2. Count unique products sold:
COUNTD([Product ID])

3. Count distinct order dates:
COUNTD([Order Date])
```

---

**Practical Use:**
```
Task: Calculate average sales per customer

SUM([Sales]) / COUNTD([Customer ID])

Explanation:
Total sales divided by number of unique customers
```

---

### B. MIN / MAX

**Beyond numbers - works on dates and strings**

**Date Examples:**
```
Task: First order date

MIN([Order Date])

Task: Most recent order date

MAX([Order Date])

Task: Days since last order

DATEDIFF('day', MAX([Order Date]), TODAY())
```

---

**String Examples:**
```
MIN([Product Name])  ← Alphabetically first
MAX([Product Name])  ← Alphabetically last

Example:
Products: "Apple", "Banana", "Cherry"
MIN → "Apple"
MAX → "Cherry"
```

---

### C. FIXED (Preview - Covered in LOD section)

**Quick intro:**
```
{FIXED [Dimension] : AGG([Measure])}

Task: Total sales across entire dataset

{FIXED : SUM([Sales])}

Returns same value for every row
```

---

## 7. Type Conversion Functions

### A. STR (Number to String)

**Syntax:**
```
STR([Number Field])
```

---

**Examples:**
```
Task: Convert year to string for concatenation

STR(YEAR([Order Date]))

Result: "2023" (as text, not number)

Task: Create label

"Year " + STR(YEAR([Order Date]))
Result: "Year 2023"
```

---

### B. INT / FLOAT

**INT(expression)**
```
Converts to integer (whole number)

INT(3.7) → 3
INT(3.2) → 3
INT(-3.7) → -4 (rounds down)
```

---

**FLOAT(expression)**
```
Converts to decimal number

FLOAT("3.14") → 3.14
```

---

### C. DATE / DATETIME

**DATE(expression)**
```
Converts to date

DATE("2023-03-15") → 3/15/2023
DATE("March 15, 2023") → 3/15/2023
```

---

**DATETIME(expression)**
```
Converts to datetime

DATETIME("2023-03-15 14:30:00")
```

---

## 8. Table Calculations

**What are they?**
Calculations performed on the query results (not row-level data)

**Key Difference:**
- **Regular calculations:** Operate on database rows
- **Table calculations:** Operate on visualization data

---

### A. Quick Table Calculations

**Adding via Menu:**
```
Steps:
1. Drag measure to view
2. Right-click measure pill
3. Select "Quick Table Calculation"
4. Choose calculation type
```

**Available Quick Table Calculations:**
- Running Total
- Difference
- Percent Difference
- Percent of Total
- Rank
- Percentile
- Moving Average
- YTD Total
- Compound Growth Rate
- Year over Year Growth
- YTD Growth

---

### B. Running Total

**What it does:** Cumulative sum

**Hands-On Example:**
```
Task: Show cumulative sales over time

Steps:
1. Order Date (Month) on Columns
2. Sales on Rows
3. Right-click Sales → Quick Table Calculation → Running Total
4. Shows cumulative sales month by month
```

**Result:**
```
Jan: 1000
Feb: 2500 (1000 + 1500)
Mar: 4000 (2500 + 1500)
```

---

**Compute Using:**
```
Defines direction of calculation

Right-click table calc pill → Compute Using:
- Table (down)
- Table (across)
- Table (across then down)
- Cell
- Specific dimensions
```

---

### C. Difference

**What it does:** Shows change from previous value

**Example:**
```
Task: Show month-over-month sales change

Steps:
1. Order Date (Month) on Columns
2. Sales on Rows
3. Right-click Sales → Quick Table Calculation → Difference

Result:
Jan: - (no previous value)
Feb: +500 (difference from Jan)
Mar: -200 (difference from Feb)
```

---

### D. Percent Difference

**What it does:** Percentage change from previous value

**Example:**
```
Task: Month-over-month growth rate

Steps:
1. Order Date (Month) on Columns
2. Sales on Rows
3. Right-click Sales → Quick Table Calculation → Percent Difference

Result:
Feb: +50% (50% increase from Jan)
Mar: -13.3% (13.3% decrease from Feb)
```

---

### E. Percent of Total

**What it does:** Shows percentage contribution

**Example:**
```
Task: Each category's % of total sales

Steps:
1. Category on Rows
2. Sales on Rows
3. Right-click Sales → Quick Table Calculation → Percent of Total

Result:
Furniture: 32.4%
Office Supplies: 31.2%
Technology: 36.4%
Total: 100%
```

---

### F. Rank

**What it does:** Assigns rank order

**Example:**
```
Task: Rank products by sales

Steps:
1. Product Name on Rows
2. Sales on Rows
3. Right-click Sales → Quick Table Calculation → Rank

Result:
Product A: 1 (highest sales)
Product B: 2
Product C: 3
```

**Rank Options:**
- Competition (1, 2, 2, 4) ← Ties share rank
- Unique (1, 2, 3, 4) ← No ties
- Dense (1, 2, 2, 3) ← No gaps after ties

---

### G. Moving Average

**What it does:** Average over sliding window

**Example:**
```
Task: 3-month moving average

Steps:
1. Order Date (Month) on Columns
2. Sales on Rows
3. Right-click Sales → Quick Table Calculation → Moving Average
4. Edit Table Calculation → Change to 3 (previous 2 + current)

Result:
Jan: 1000 (only 1 value)
Feb: 1250 (avg of Jan, Feb)
Mar: 1333 (avg of Jan, Feb, Mar)
Apr: 1400 (avg of Feb, Mar, Apr)
```

---

### H. Year-to-Date (YTD) Total

**What it does:** Cumulative total within each year

**Example:**
```
Task: YTD sales

Steps:
1. Order Date (Month) on Columns
2. Sales on Rows
3. Right-click Sales → Quick Table Calculation → YTD Total

Result:
Jan 2023: 1000
Feb 2023: 2500
...
Dec 2023: 45000
Jan 2024: 1200 (resets for new year)
Feb 2024: 3000
```

---

## 9. LOD Expressions (Level of Detail)

**What are they?**
Control the granularity at which calculations are performed

**Three Types:**
1. **FIXED:** Ignores view dimensions
2. **INCLUDE:** Adds dimensions to view
3. **EXCLUDE:** Removes dimensions from view

---

### A. FIXED LOD

**Syntax:**
```
{FIXED [Dimension1], [Dimension2], ... : AGG([Measure])}
```

**What it does:**
Calculates at specified dimension level, ignoring what's in the view

---

**Example 1: Total sales (ignoring all dimensions)**
```
Calculation Name: Total Sales
Formula:
{FIXED : SUM([Sales])}

Returns same value in every row: total sales

Use case: Calculate percentage of total
SUM([Sales]) / {FIXED : SUM([Sales])}
```

---

**Example 2: Sales per customer (fixed level)**
```
Task: Calculate each customer's total sales

Calculation:
{FIXED [Customer ID] : SUM([Sales])}

Result:
Every row with same Customer ID shows their total sales

Use in view:
- Shows customer's total regardless of other dimensions
- Can compare individual order to customer total
```

---

**Example 3: Category-level averages**
```
Task: Average sales per category, shown at product level

Calculation:
{FIXED [Category] : AVG([Sales])}

View: Product Name on Rows, Calculation on Columns

Result:
Each product shows its category's average
All furniture products show same value (furniture avg)
```

---

**Practical Example:**
```
Task: Show if each order is above customer's average

Step 1 - Customer Average:
{FIXED [Customer ID] : AVG([Sales])}

Step 2 - Comparison:
IF [Sales] > {FIXED [Customer ID] : AVG([Sales])}
THEN "Above Average"
ELSE "Below Average"
END
```

---

### B. INCLUDE LOD

**Syntax:**
```
{INCLUDE [Dimension] : AGG([Measure])}
```

**What it does:**
Adds dimension to aggregation, even if not in view

---

**Example 1: Average sales per customer by region**
```
View: Region on Rows, Sales on Columns

Without INCLUDE:
AVG([Sales]) → Average of all orders in region

With INCLUDE:
{INCLUDE [Customer ID] : SUM([Sales])}

Then:
AVG({INCLUDE [Customer ID] : SUM([Sales])})

Result: Average sales per customer (not per order)
```

---

**Example 2: Count of products per category**
```
Task: Show average number of products sold per category

View: Category on Rows

Calculation:
{INCLUDE [Product ID] : SUM([Quantity])}

Then:
AVG({INCLUDE [Product ID] : SUM([Quantity])})

Shows: Average quantity per product in each category
```

---

### C. EXCLUDE LOD

**Syntax:**
```
{EXCLUDE [Dimension] : AGG([Measure])}
```

**What it does:**
Removes dimension from aggregation

---

**Example 1: Category total in product view**
```
View: Category on Rows, Product Name on Columns, Sales in cells

Without EXCLUDE:
SUM([Sales]) → Sales for each Category-Product combination

With EXCLUDE:
{EXCLUDE [Product Name] : SUM([Sales])}

Result: Shows category total for all products
```

---

**Example 2: Percent of category sales**
```
Task: Each product's % of its category's sales

Product Sales / Category Sales

Calculation:
SUM([Sales]) / {EXCLUDE [Product Name] : SUM([Sales])}

View: Category and Product Name on Rows

Result:
Chairs / Furniture Total = 35%
Tables / Furniture Total = 40%
etc.
```

---

### D. LOD vs Regular Aggregation

**Scenario: Average Sales**

**Data:**
```
Order 1: $100
Order 2: $150
Order 3: $200
```

**Regular AVG:**
```
AVG([Sales]) in view → 150
(Average of visible orders)
```

**LOD FIXED:**
```
{FIXED [Customer ID] : AVG([Sales])}
First: Average per customer
Then: Show in view
```

**When to use LOD:**
- Multi-level aggregations
- Calculations independent of view
- Comparing to totals/averages at different levels

---

## 10. Combining Functions - Complex Examples

### Example 1: Customer Lifetime Value
```
Task: Total value of all orders per customer

Name: Customer Lifetime Value
Formula:
{FIXED [Customer ID] : SUM([Sales])}

Then create categories:
IF {FIXED [Customer ID] : SUM([Sales])} > 10000 THEN "VIP"
ELSEIF {FIXED [Customer ID] : SUM([Sales])} > 5000 THEN "Premium"
ELSE "Regular"
END
```

---

### Example 2: Days Since Last Order
```
Name: Days Since Last Order
Formula:
DATEDIFF('day', 
    {FIXED [Customer ID] : MAX([Order Date])}, 
    TODAY()
)

Shows how many days since customer's last order
```

---

### Example 3: Growth Rate
```
Task: Year-over-year growth rate

Name: YoY Growth %
Formula:
(SUM([Sales]) - LOOKUP(SUM([Sales]), -1)) 
/ 
LOOKUP(SUM([Sales]), -1)

LOOKUP gets previous year's value
Calculate percentage change
```

---

### Example 4: Product Performance Score
```
Task: Composite score based on sales and profit

Name: Performance Score
Formula:
(
    (SUM([Sales]) - {FIXED : MIN([Sales])}) 
    / 
    ({FIXED : MAX([Sales])} - {FIXED : MIN([Sales])})
    * 0.5
)
+
(
    (SUM([Profit]) - {FIXED : MIN([Profit])}) 
    / 
    ({FIXED : MAX([Profit])} - {FIXED : MIN([Profit])}) * 0.5
)

Explanation:
- Normalizes Sales and Profit to 0-1 scale
- Weights each 50%
- Score ranges from 0 to 1
```

---

### Example 5: Cohort Analysis
```
Task: Identify customer's first order month

Name: First Order Month
Formula:
{FIXED [Customer ID] : MIN([Order Date])}

Then calculate cohort age:
DATEDIFF('month', 
    {FIXED [Customer ID] : MIN([Order Date])},
    [Order Date]
)

Shows how many months after first order this order occurred
```

---

### Example 6: Above/Below Average Indicator
```
Task: Flag orders above category average

Name: Performance vs Category
Formula:
IF [Sales] > {FIXED [Category] : AVG([Sales])}
THEN "▲ Above Average"
ELSE "▼ Below Average"
END

Use in visualization:
- Drag to Color for visual encoding
- Shows immediately which orders outperform
```

---

### Example 7: Recency, Frequency, Monetary (RFM)
```
Recency Score:
Name: Recency Score
Formula:
IF DATEDIFF('day', {FIXED [Customer ID] : MAX([Order Date])}, TODAY()) <= 30 
THEN 5
ELSEIF DATEDIFF('day', {FIXED [Customer ID] : MAX([Order Date])}, TODAY()) <= 90 
THEN 4
ELSEIF DATEDIFF('day', {FIXED [Customer ID] : MAX([Order Date])}, TODAY()) <= 180 
THEN 3
ELSEIF DATEDIFF('day', {FIXED [Customer ID] : MAX([Order Date])}, TODAY()) <= 365 
THEN 2
ELSE 1
END

Frequency Score:
Name: Frequency Score
Formula:
IF {FIXED [Customer ID] : COUNTD([Order ID])} >= 20 THEN 5
ELSEIF {FIXED [Customer ID] : COUNTD([Order ID])} >= 10 THEN 4
ELSEIF {FIXED [Customer ID] : COUNTD([Order ID])} >= 5 THEN 3
ELSEIF {FIXED [Customer ID] : COUNTD([Order ID])} >= 2 THEN 2
ELSE 1
END

Monetary Score:
Name: Monetary Score
Formula:
IF {FIXED [Customer ID] : SUM([Sales])} >= 10000 THEN 5
ELSEIF {FIXED [Customer ID] : SUM([Sales])} >= 5000 THEN 4
ELSEIF {FIXED [Customer ID] : SUM([Sales])} >= 2000 THEN 3
ELSEIF {FIXED [Customer ID] : SUM([Sales])} >= 500 THEN 2
ELSE 1
END

Combined RFM Score:
Name: RFM Score
Formula:
[Recency Score] + [Frequency Score] + [Monetary Score]

Ranges from 3 to 15
```

---

### Example 8: Running Percentage of Total
```
Task: Show what % of total has been achieved so far

Name: Running % of Total
Formula:
RUNNING_SUM(SUM([Sales])) 
/ 
TOTAL(SUM([Sales]))

Use with:
- Order Date on Columns (Month)
- This calculation on Rows
- Shows cumulative percentage reaching 100%
```

---

### Example 9: Pareto Analysis (80/20 Rule)
```
Task: Identify top products contributing to 80% of sales

Step 1 - Rank by Sales:
Name: Sales Rank
Formula:
RANK_UNIQUE(SUM([Sales]), 'desc')

Step 2 - Running % of Total:
Name: Running Sales %
Formula:
RUNNING_SUM(SUM([Sales])) / TOTAL(SUM([Sales]))

Step 3 - Top 80% Flag:
Name: Top 80%
Formula:
IF [Running Sales %] <= 0.8 THEN "Top 80%"
ELSE "Bottom 20%"
END

Use in view:
- Product Name on Rows (sorted by Sales Rank)
- Sales on Columns
- Color by "Top 80%" field
```

---

### Example 10: Same Period Last Year
```
Task: Compare this year's sales to same period last year

Name: Sales Same Period LY
Formula:
{FIXED 
    DATEPART('year', [Order Date]) - 1,
    DATEPART('month', [Order Date]) 
    : SUM([Sales])
}

This is complex - better approach using table calc:

Name: Sales vs LY
Formula:
(SUM([Sales]) - LOOKUP(SUM([Sales]), -12)) 
/ 
LOOKUP(SUM([Sales]), -12)

Use with:
- Order Date (Month) on Columns
- Compute Using: Order Date
```

---

## 11. Common Exam Scenarios

### Scenario 1: Profitable vs Unprofitable Orders
```
Task: Create calculated field to categorize orders

Solution:
Name: Profit Status
Formula:
IF [Profit] > 0 THEN "Profitable"
ELSEIF [Profit] = 0 THEN "Break-even"
ELSE "Loss"
END

Use: Drag to Color, Filters, or Rows
```

---

### Scenario 2: Discount Impact Analysis
```
Task: Show average profit for discounted vs non-discounted orders

Solution:
Name: Discount Status
Formula:
IIF([Discount] > 0, "Discounted", "Full Price")

Then create view:
- Discount Status on Columns
- AVG(Profit) on Rows
- Compare average profitability
```

---

### Scenario 3: High-Value Order Threshold
```
Task: Flag orders above $500 as "High Value"

Solution:
Name: Order Value Category
Formula:
IF [Sales] >= 500 THEN "High Value"
ELSE "Standard"
END

Enhanced version with more categories:
IF [Sales] >= 1000 THEN "Premium"
ELSEIF [Sales] >= 500 THEN "High Value"
ELSEIF [Sales] >= 100 THEN "Standard"
ELSE "Low Value"
END
```

---

### Scenario 4: Average Order Value by Customer
```
Task: Calculate average order value for each customer

Solution:
Name: Customer Avg Order Value
Formula:
{FIXED [Customer ID] : SUM([Sales])} 
/ 
{FIXED [Customer ID] : COUNTD([Order ID])}

Or simpler:
{FIXED [Customer ID] : AVG([Sales])}

Use to identify:
- High-value customers
- Upsell opportunities
```

---

### Scenario 5: Orders Shipped On Time
```
Task: Flag orders shipped within 3 days

Solution:
Name: Shipping Status
Formula:
IF DATEDIFF('day', [Order Date], [Ship Date]) <= 3 
THEN "On Time"
ELSE "Delayed"
END

Count on-time percentage:
COUNTD(IF [Shipping Status] = "On Time" THEN [Order ID] END)
/
COUNTD([Order ID])
```

---

### Scenario 6: Product Name Cleanup
```
Task: Remove product codes from names

Example: "TEC-MA-10000822" → "TEC-MA"

Solution:
Name: Product Code
Formula:
LEFT([Product ID], 6)

Or extract category prefix:
SPLIT([Product ID], "-", 1)
```

---

### Scenario 7: Customer Segmentation
```
Task: Segment customers into quartiles by total spending

Solution:
Name: Customer Total Sales
Formula:
{FIXED [Customer ID] : SUM([Sales])}

Name: Customer Segment
Formula:
IF [Customer Total Sales] >= {FIXED : PERCENTILE([Customer Total Sales], 0.75)}
THEN "Top 25%"
ELSEIF [Customer Total Sales] >= {FIXED : PERCENTILE([Customer Total Sales], 0.50)}
THEN "51-75%"
ELSEIF [Customer Total Sales] >= {FIXED : PERCENTILE([Customer Total Sales], 0.25)}
THEN "26-50%"
ELSE "Bottom 25%"
END
```

---

### Scenario 8: Month-over-Month Growth
```
Task: Calculate MoM growth percentage

Solution:
Name: MoM Growth %
Formula:
(SUM([Sales]) - LOOKUP(SUM([Sales]), -1))
/
ABS(LOOKUP(SUM([Sales]), -1))

Note: Use ABS() to handle negative values correctly

Add to view:
- Order Date (Month) on Columns
- Sales on Rows
- This calculation on Rows (secondary axis)
```

---

### Scenario 9: Days in Current Status
```
Task: Calculate how long order has been in current status

Solution:
Name: Days in Status
Formula:
DATEDIFF('day', [Status Change Date], TODAY())

Or for specific status:
IF [Status] = "Pending"
THEN DATEDIFF('day', [Order Date], TODAY())
ELSE 0
END
```

---

### Scenario 10: Composite Search Field
```
Task: Create searchable field combining multiple attributes

Solution:
Name: Search String
Formula:
LOWER(
    [Customer Name] + " " +
    [Product Name] + " " +
    [Category] + " " +
    [City] + " " +
    [State]
)

Use with wildcard filter:
- Drag to Filters
- Wildcard → Contains
- Users can search any term
```

---

## 12. Calculation Best Practices

### A. Naming Conventions
```
✓ Good:
- Customer Lifetime Value
- Profit Ratio
- Days Since Order
- High Value Flag

✗ Avoid:
- Calc1
- New Calculation
- Copy of Sales
- temp
```

---

### B. Comments in Calculations
```
Use // for comments

Example:
// Calculate profit margin as percentage
[Profit] / [Sales]

Or:
IF [Sales] > 1000 THEN "High"  // Orders above $1000
ELSE "Low"  // Orders $1000 or below
END
```

---

### C. Testing Calculations
```
1. Create simple test view:
   - Drag calculation to Rows
   - Add related fields
   - Verify results manually

2. Use sample data with known outcomes

3. Check edge cases:
   - Null values
   - Zero values
   - Negative numbers
   - Extreme values

4. Compare to expected results
```

---

### D. Performance Considerations

**Faster Calculations:**
```
✓ Use LOD when needed, but not excessively
✓ Use table calculations instead of LOD when possible
✓ Avoid nested LODs
✓ Use COUNTD sparingly (expensive operation)
✓ Filter data before calculating

✗ Avoid:
- Multiple nested FIXED calculations
- Complex string operations on large datasets
- Unnecessary COUNTD operations
```

---

### E. Error Handling
```
Division by zero:
IF [Sales] != 0 
THEN [Profit] / [Sales]
ELSE 0
END

Or:
[Profit] / IFNULL([Sales], 1)

Null handling:
ZN([Profit]) / IFNULL([Sales], 1)

Date validation:
IF NOT ISNULL([Order Date]) AND NOT ISNULL([Ship Date])
THEN DATEDIFF('day', [Order Date], [Ship Date])
ELSE NULL
END
```

---

## 13. Quick Reference Tables

### Function Categories

**String Functions:**
```
UPPER, LOWER, PROPER          - Case conversion
LEFT, RIGHT, MID              - Substring extraction
LEN                           - String length
TRIM, LTRIM, RTRIM           - Remove spaces
REPLACE, SUBSTITUTE           - Replace text
CONTAINS, STARTSWITH, ENDSWITH - Text matching
FIND                          - Find position
SPLIT                         - Split string
+ operator                    - Concatenate
```

---

**Date Functions:**
```
TODAY, NOW                    - Current date/time
YEAR, MONTH, DAY             - Extract date parts
DATEPART, DATENAME           - Extract with options
DATEADD                       - Add time period
DATEDIFF                      - Calculate difference
DATE, MAKEDATE               - Create dates
DATETIME, MAKEDATETIME       - Create datetimes
```

---

**Logical Functions:**
```
IF-THEN-ELSE                 - Conditional logic
CASE                          - Multiple conditions
IIF                           - Inline IF
AND, OR, NOT                 - Boolean logic
IN                            - Check membership
ISNULL                        - Check for nulls
IFNULL, ZN                   - Replace nulls
```

---

**Aggregate Functions:**
```
SUM                           - Total
AVG                           - Average
MIN, MAX                      - Minimum/Maximum
COUNT                         - Count rows
COUNTD                        - Count distinct
MEDIAN                        - Median value
STDEV, VAR                   - Statistical measures
PERCENTILE                    - Percentile value
```

---

**Type Conversion:**
```
STR                           - Number to string
INT                           - To integer
FLOAT                         - To decimal
DATE                          - To date
DATETIME                      - To datetime
BOOL                          - To boolean
```

---

**Table Calculations:**
```
RUNNING_SUM                   - Cumulative total
LOOKUP                        - Reference other marks
PREVIOUS_VALUE               - Previous calculation result
WINDOW_SUM                    - Aggregate across window
RANK, RANK_UNIQUE            - Ranking
INDEX                         - Position in partition
FIRST, LAST                  - First/last in partition
SIZE                          - Number of rows
TOTAL                         - Grand total
```

---

## 14. Practice Exercises

### Exercise 1: Customer Analysis
```
Create these calculations:

1. Customer Total Orders
{FIXED [Customer ID] : COUNTD([Order ID])}

2. Customer Total Spent
{FIXED [Customer ID] : SUM([Sales])}

3. Customer Segment
IF [Customer Total Orders] >= 10 AND [Customer Total Spent] >= 5000
THEN "VIP"
ELSEIF [Customer Total Orders] >= 5
THEN "Regular"
ELSE "New"
END

4. Average Order Size
{FIXED [Customer ID] : SUM([Sales])} / {FIXED [Customer ID] : COUNTD([Order ID])}

Build view showing customers by segment with metrics
```

---

### Exercise 2: Product Performance
```
Create these calculations:

1. Profit Margin %
[Profit] / [Sales]

2. Margin Category
IF [Profit Margin %] >= 0.30 THEN "Excellent"
ELSEIF [Profit Margin %] >= 0.20 THEN "Good"
ELSEIF [Profit Margin %] >= 0.10 THEN "Fair"
ELSEIF [Profit Margin %] >= 0 THEN "Poor"
ELSE "Loss"
END

3. Sales Rank
RANK_UNIQUE(SUM([Sales]), 'desc')

4. Top 20 Products
[Sales Rank] <= 20

Build view showing products colored by margin category
```

---

### Exercise 3: Time Analysis
```
Create these calculations:

1. Order to Ship Days
DATEDIFF('day', [Order Date], [Ship Date])

2. Shipping Performance
IF [Order to Ship Days] <= 2 THEN "Excellent"
ELSEIF [Order to Ship Days] <= 4 THEN "Good"
ELSEIF [Order to Ship Days] <= 7 THEN "Acceptable"
ELSE "Poor"
END

3. Order Month-Year
DATENAME('month', [Order Date]) + " " + STR(YEAR([Order Date]))

4. Is Recent Order
DATEDIFF('day', [Order Date], TODAY()) <= 90

Build dashboard showing shipping performance trends
```

---

### Exercise 4: Cohort Retention
```
Create these calculations:

1. Customer First Order
{FIXED [Customer ID] : MIN([Order Date])}

2. Cohort Month
DATE(YEAR([Customer First Order]), MONTH([Customer First Order]), 1)

3. Months Since First Order
DATEDIFF('month', [Customer First Order], [Order Date])

4. Cohort Size
{FIXED [Cohort Month] : COUNTD([Customer ID])}

Build cohort retention matrix
```

---

### Exercise 5: Sales Forecast Helper
```
Create these calculations:

1. 3-Month Moving Average
WINDOW_AVG(SUM([Sales]), -2, 0)

2. Sales Growth Rate
(SUM([Sales]) - LOOKUP(SUM([Sales]), -12)) / ABS(LOOKUP(SUM([Sales]), -12))

3. Seasonality Index
SUM([Sales]) / WINDOW_AVG(SUM([Sales]))

4. Trend Line
SCRIPT_REAL("
    fitted(lm(.arg1 ~ seq_along(.arg1)))
", SUM([Sales]))

Build view showing historical sales with trends
```

---

## 15. Common Errors and Solutions

### Error 1: "Cannot mix aggregate and non-aggregate"
```
❌ Wrong:
[Sales] / COUNT([Order ID])

✓ Correct:
SUM([Sales]) / COUNT([Order ID])

Explanation: Must aggregate both or neither
```

---

### Error 2: "All fields must be aggregate or LOD"
```
❌ Wrong:
SUM([Sales]) + [Profit]

✓ Correct:
SUM([Sales]) + SUM([Profit])

Explanation: Can't mix aggregated and non-aggregated in same calc
```

---

### Error 3: Division by zero
```
❌ Risky:
[Profit] / [Sales]

✓ Safe:
IF [Sales] != 0 THEN [Profit] / [Sales] ELSE 0 END

Or:
ZN([Profit]) / IFNULL([Sales], 1)
```

---

### Error 4: Date comparison with wrong format
```
❌ Wrong:
[Order Date] > "2023-01-01"

✓ Correct:
[Order Date] > DATE("2023-01-01")

Or:
[Order Date] > #2023-01-01#
```

---

### Error 5: String concatenation with numbers
```
❌ Wrong:
"Year " + YEAR([Order Date])

✓ Correct:
"Year " + STR(YEAR([Order Date]))

Explanation: Convert number to string for concatenation
```

---

### Error 6: Incorrect LOD syntax
```
❌ Wrong:
{FIXED [Customer ID] = SUM([Sales])}

✓ Correct:
{FIXED [Customer ID] : SUM([Sales])}

Explanation: Use colon (:) not equals (=)
```

---

### Error 7: Table calculation without proper compute
```
Issue: RUNNING_SUM showing same value for all marks

Solution:
1. Right-click table calc pill
2. Click "Edit Table Calculation"
3. Set correct "Compute Using" option
4. Choose dimension to calculate along
```

---

### Error 8: Nested aggregations
```
❌ Wrong:
SUM(AVG([Sales]))

✓ Use LOD instead:
{FIXED [Category] : AVG([Sales])}
Then: SUM([Category Average])

Or use separate calculations:
Calc1: AVG([Sales]) per category
Calc2: SUM([Calc1])
```

---

## Module 3 Summary Checklist

**Calculated Fields:**
- [ ] Create row-level calculations
- [ ] Create aggregated calculations
- [ ] Use operators (+, -, *, /, AND, OR)
- [ ] Reference fields with [Field Name]

**String Functions:**
- [ ] UPPER, LOWER, TRIM
- [ ] LEFT, RIGHT, MID
- [ ] CONTAINS, STARTSWITH, ENDSWITH
- [ ] SPLIT, FIND, REPLACE
- [ ] Concatenation with +

**Date Functions:**
- [ ] TODAY, NOW, DATE
- [ ] YEAR, MONTH, DAY, DATEPART
- [ ] DATEADD, DATEDIFF
- [ ] DATENAME for text output

**Logical Functions:**
- [ ] IF-THEN-ELSE statements
- [ ] CASE statements
- [ ] IIF inline conditionals
- [ ] IN operator
- [ ] ISNULL, IFNULL, ZN

**Aggregations:**
- [ ] SUM, AVG, MIN, MAX
- [ ] COUNT, COUNTD
- [ ] MEDIAN, PERCENTILE
- [ ] Use in calculated fields

**Table Calculations:**
- [ ] Quick table calculations
- [ ] Running Total
- [ ] Difference, % Difference
- [ ] Rank, Percentile
- [ ] Moving Average
- [ ] Compute Using settings

**LOD Expressions:**
- [ ] FIXED - ignore view dimensions
- [ ] INCLUDE - add dimensions
- [ ] EXCLUDE - remove dimensions
- [ ] Syntax: {LOD [Dim] : AGG([Measure])}

---

**Ready for Module 4 (Advanced Visualizations)?** Let me know when you want notes on Dual Axis, Heat Maps, Treemaps, Waterfall Charts, and more complex visualization types!
