# MODULE 4: Calculations (Continued)

---

## **Topic 15: Logical Functions (IF, CASE)**

### **What are Logical Functions?**

**Logical functions** = Apply conditional logic to create different outputs based on conditions

Think: "IF this, THEN that, ELSE something else"

**Why use logical functions?**
‚úÖ Categorize data (High/Medium/Low)
‚úÖ Apply business rules
‚úÖ Handle multiple scenarios
‚úÖ Create custom groupings
‚úÖ Data quality checks

---

### **IF Statements**

**Basic IF syntax:**
```
IF <condition> THEN <value_if_true>
ELSE <value_if_false>
END
```

**Example 1: Profit Status**
```
IF SUM([Profit]) > 0 THEN "Profitable"
ELSE "Loss"
END
```

**Example 2: Discount Flag**
```
IF [Discount] > 0 THEN "Discounted"
ELSE "Full Price"
END
```

---

### **IF-ELSEIF-ELSE (Multiple Conditions)**

**Syntax:**
```
IF <condition1> THEN <value1>
ELSEIF <condition2> THEN <value2>
ELSEIF <condition3> THEN <value3>
ELSE <default_value>
END
```

**Example: Sales Tier**
```
IF SUM([Sales]) >= 100000 THEN "Platinum"
ELSEIF SUM([Sales]) >= 50000 THEN "Gold"
ELSEIF SUM([Sales]) >= 10000 THEN "Silver"
ELSE "Bronze"
END
```

**Execution order:** Checks conditions top-to-bottom, stops at first TRUE

---

### **Nested IF Statements**

**IF inside another IF:**

**Example: Complex Categorization**
```
IF [Region] = "West" THEN
    IF SUM([Sales]) > 50000 THEN "West-High"
    ELSE "West-Low"
    END
ELSEIF [Region] = "East" THEN
    IF SUM([Sales]) > 50000 THEN "East-High"
    ELSE "East-Low"
    END
ELSE "Other"
END
```

**‚ö†Ô∏è Warning:** Deep nesting = hard to read. Consider CASE instead for many conditions.

---

### **Comparison Operators in IF**

**Numeric comparisons:**
- `=` Equal to
- `!=` or `<>` Not equal to
- `>` Greater than
- `<` Less than
- `>=` Greater than or equal
- `<=` Less than or equal

**Examples:**
```
[Sales] > 1000
[Quantity] <= 5
[Profit] != 0
```

---

**String comparisons:**
```
[Category] = "Furniture"
[Customer Name] != "Unknown"
```

**‚ö†Ô∏è Case-sensitive by default!**
- `"Furniture" = "furniture"` ‚Üí FALSE

**Case-insensitive comparison:**
```
LOWER([Category]) = "furniture"
```

---

**Date comparisons:**
```
[Order Date] > #2023-01-01#
[Ship Date] <= TODAY()
[Order Date] = DATETRUNC('month', TODAY())
```

---

### **Logical Operators: AND, OR, NOT**

**AND - All conditions must be TRUE:**
```
IF [Sales] > 1000 AND [Region] = "West" THEN "Qualified"
ELSE "Not Qualified"
END
```

**OR - At least one condition must be TRUE:**
```
IF [Category] = "Furniture" OR [Category] = "Technology" THEN "Focus Category"
ELSE "Other"
END
```

**NOT - Reverses condition:**
```
IF NOT [Returned] THEN "Kept"
ELSE "Returned"
END
```

---

**Combining operators:**
```
IF ([Sales] > 1000 AND [Region] = "West") 
   OR ([Sales] > 2000 AND [Region] = "East")
THEN "Target Market"
ELSE "Standard"
END
```

**Use parentheses** to control logic order!

---

### **IN Operator** ‚≠ê **Very Useful!**

**Check if value is in a list:**

**Instead of multiple OR:**
```
‚ùå IF [Region] = "West" OR [Region] = "East" OR [Region] = "South"
```

**Use IN:**
```
‚úì IF [Region] IN ("West", "East", "South") THEN "Included"
ELSE "Excluded"
END
```

**Much cleaner for many values!**

---

**Numeric IN:**
```
IF [Status Code] IN (1, 2, 3) THEN "Active"
ELSE "Inactive"
END
```

**NOT IN:**
```
IF [Category] NOT IN ("Furniture", "Technology") THEN "Other Categories"
ELSE "Core Categories"
END
```

---

### **NULL Handling in IF**

**NULL = Missing/undefined value**

**Problem: NULL in comparisons**
```
IF [Middle Name] = "Smith" THEN "Match"
ELSE "No Match"
END
```
If Middle Name is NULL ‚Üí Goes to ELSE (doesn't match)

---

**Checking for NULL:**
```
IF ISNULL([Middle Name]) THEN "No Middle Name"
ELSE [Middle Name]
END
```

**Alternative:**
```
IF [Middle Name] = NULL THEN "No Middle Name"  // This works too
ELSE [Middle Name]
END
```

---

**IFNULL() function:**
```
IFNULL([Bonus], 0)
```
If Bonus is NULL, returns 0, otherwise returns Bonus value.

**ZN() function (Zero if Null):**
```
ZN([Bonus])
```
Shortcut for numeric fields - converts NULL to 0.

---

### **Practical IF Examples:**

**1. Age Groups:**
```
IF [Age] < 18 THEN "Minor"
ELSEIF [Age] < 30 THEN "Young Adult"
ELSEIF [Age] < 50 THEN "Adult"
ELSEIF [Age] < 65 THEN "Middle Age"
ELSE "Senior"
END
```

**2. Performance Rating:**
```
IF SUM([Sales]) >= SUM([Target]) THEN "Met Target"
ELSE "Below Target"
END
```

**3. Shipping Speed:**
```
IF DATEDIFF('day', [Order Date], [Ship Date]) <= 2 THEN "Fast"
ELSEIF DATEDIFF('day', [Order Date], [Ship Date]) <= 5 THEN "Standard"
ELSE "Slow"
END
```

**4. Price Category:**
```
IF [Price] = 0 THEN "Free"
ELSEIF [Price] < 50 THEN "Budget"
ELSEIF [Price] < 200 THEN "Mid-Range"
ELSE "Premium"
END
```

**5. Region Grouping:**
```
IF [State] IN ("CA", "OR", "WA") THEN "West Coast"
ELSEIF [State] IN ("NY", "NJ", "PA") THEN "Northeast"
ELSEIF [State] IN ("TX", "FL", "GA") THEN "South"
ELSE "Other"
END
```

**6. Valid Email Check:**
```
IF CONTAINS([Email], "@") AND CONTAINS([Email], ".") THEN "Valid"
ELSE "Invalid"
END
```

---

### **CASE Statements** ‚≠ê **Cleaner than multiple IF-ELSEIF**

**CASE** = Alternative to IF-ELSEIF for multiple conditions

**Two types:**
1. **Simple CASE** - Compare one field to multiple values
2. **Searched CASE** - Multiple different conditions

---

### **Simple CASE Statement**

**Syntax:**
```
CASE <field>
    WHEN <value1> THEN <result1>
    WHEN <value2> THEN <result2>
    WHEN <value3> THEN <result3>
    ELSE <default>
END
```

**Example: Region Names**
```
CASE [Region Code]
    WHEN 1 THEN "North"
    WHEN 2 THEN "South"
    WHEN 3 THEN "East"
    WHEN 4 THEN "West"
    ELSE "Unknown"
END
```

**Equivalent IF statement:**
```
IF [Region Code] = 1 THEN "North"
ELSEIF [Region Code] = 2 THEN "South"
ELSEIF [Region Code] = 3 THEN "East"
ELSEIF [Region Code] = 4 THEN "West"
ELSE "Unknown"
END
```

**CASE is cleaner when comparing one field to many values!**

---

**Example: Month Names**
```
CASE MONTH([Order Date])
    WHEN 1 THEN "January"
    WHEN 2 THEN "February"
    WHEN 3 THEN "March"
    WHEN 4 THEN "April"
    WHEN 5 THEN "May"
    WHEN 6 THEN "June"
    WHEN 7 THEN "July"
    WHEN 8 THEN "August"
    WHEN 9 THEN "September"
    WHEN 10 THEN "October"
    WHEN 11 THEN "November"
    WHEN 12 THEN "December"
END
```

*Note: DATENAME('month', [Date]) does this automatically, but this shows CASE usage*

---

### **Searched CASE Statement**

**Syntax:**
```
CASE
    WHEN <condition1> THEN <result1>
    WHEN <condition2> THEN <result2>
    WHEN <condition3> THEN <result3>
    ELSE <default>
END
```

**No field after CASE - each WHEN has its own condition**

---

**Example: Sales Performance**
```
CASE
    WHEN SUM([Sales]) >= 100000 THEN "Excellent"
    WHEN SUM([Sales]) >= 50000 THEN "Good"
    WHEN SUM([Sales]) >= 10000 THEN "Fair"
    ELSE "Poor"
END
```

**Equivalent IF:**
```
IF SUM([Sales]) >= 100000 THEN "Excellent"
ELSEIF SUM([Sales]) >= 50000 THEN "Good"
ELSEIF SUM([Sales]) >= 10000 THEN "Fair"
ELSE "Poor"
END
```

**Both work identically! Use whichever you prefer.**

---

**Example: Multiple Field Conditions**
```
CASE
    WHEN [Category] = "Furniture" AND [Sales] > 1000 THEN "High Value Furniture"
    WHEN [Category] = "Furniture" THEN "Standard Furniture"
    WHEN [Category] = "Technology" AND [Sales] > 2000 THEN "High Value Tech"
    WHEN [Category] = "Technology" THEN "Standard Tech"
    ELSE "Other Products"
END
```

---

### **CASE vs IF: When to Use Which?**

**Use CASE when:**
- ‚úÖ Comparing one field to many values (cleaner)
- ‚úÖ You prefer SQL-like syntax
- ‚úÖ Many conditions with different fields

**Use IF when:**
- ‚úÖ Simple true/false logic
- ‚úÖ Nested conditions based on multiple fields
- ‚úÖ You prefer traditional programming syntax

**They're interchangeable in most scenarios! Personal preference matters.**

---

### **Boolean Logic (TRUE/FALSE)**

Tableau has **Boolean** data type (TRUE/FALSE).

**Boolean calculated fields:**
```
[Sales] > 1000
‚Üí Returns TRUE or FALSE for each row
```

**Use in IF:**
```
IF [Sales] > 1000 THEN "High" ELSE "Low" END
```

**Or use the boolean directly:**
```
SUM(IF [Sales] > 1000 THEN 1 ELSE 0 END)
‚Üí Counts how many rows have Sales > 1000
```

---

**Counting with Boolean:**
```
// Count of high-value orders
SUM(IF [Sales] > 1000 THEN 1 ELSE 0 END)

// Percentage of profitable orders
SUM(IF [Profit] > 0 THEN 1 ELSE 0 END) / COUNT([Order ID])
```

---

### **IIF() Function** (Inline IF)

**Shortcut for simple IF-ELSE:**

**Syntax:**
```
IIF(<condition>, <true_value>, <false_value>)
```

**Example:**
```
IIF([Sales] > 1000, "High", "Low")
```

**Equivalent to:**
```
IF [Sales] > 1000 THEN "High" ELSE "Low" END
```

**Use when:** Simple true/false - cleaner than full IF statement

**Don't use when:** Multiple conditions (no ELSEIF equivalent)

---

### **Advanced Logical Examples:**

**1. Profit Margin Status with Color Hint:**
```
IF SUM([Profit]) / SUM([Sales]) >= 0.20 THEN "üü¢ Excellent"
ELSEIF SUM([Profit]) / SUM([Sales]) >= 0.10 THEN "üü° Good"
ELSEIF SUM([Profit]) / SUM([Sales]) >= 0 THEN "üü† Marginal"
ELSE "üî¥ Loss"
END
```

**2. Customer Lifetime Value Segment:**
```
CASE
    WHEN SUM([Sales]) > 10000 AND COUNTD([Order ID]) > 10 THEN "VIP"
    WHEN SUM([Sales]) > 5000 AND COUNTD([Order ID]) > 5 THEN "Loyal"
    WHEN COUNTD([Order ID]) > 1 THEN "Repeat"
    ELSE "One-Time"
END
```

**3. Shipping Priority:**
```
IF [Ship Mode] = "Same Day" THEN 1
ELSEIF [Ship Mode] = "First Class" THEN 2
ELSEIF [Ship Mode] = "Second Class" THEN 3
ELSE 4
END
```
*Numeric priority for sorting*

**4. Valid Order Check:**
```
IF [Order Date] IS NOT NULL 
   AND [Customer Name] IS NOT NULL
   AND [Sales] > 0
   AND [Quantity] > 0
THEN "Valid"
ELSE "Invalid"
END
```

**5. Quarter Label:**
```
"Q" + STR(
    CASE MONTH([Order Date])
        WHEN 1 THEN 1
        WHEN 2 THEN 1
        WHEN 3 THEN 1
        WHEN 4 THEN 2
        WHEN 5 THEN 2
        WHEN 6 THEN 2
        WHEN 7 THEN 3
        WHEN 8 THEN 3
        WHEN 9 THEN 3
        ELSE 4
    END
) + " " + STR(YEAR([Order Date]))
```
Result: "Q1 2023"

---

### **Common Logical Calculation Errors:**

**1. "Cannot mix aggregate and non-aggregate"**
```
‚ùå IF [Category] = "Furniture" THEN SUM([Sales]) ELSE 0 END
‚úì IF [Category] = "Furniture" THEN [Sales] ELSE 0 END (then aggregate)
‚úì SUM(IF [Category] = "Furniture" THEN [Sales] ELSE 0 END)
```

**2. Missing END statement**
```
‚ùå IF [Sales] > 1000 THEN "High"
‚úì IF [Sales] > 1000 THEN "High" ELSE "Low" END
```

**3. Type mismatch**
```
‚ùå IF [Sales] > 1000 THEN "High" ELSE 0 END
   (mixing string "High" and number 0)
‚úì IF [Sales] > 1000 THEN "High" ELSE "Low" END
‚úì IF [Sales] > 1000 THEN 1 ELSE 0 END
```

**4. Logic order matters**
```
‚ùå Wrong order:
IF [Sales] > 1000 THEN "High"
ELSEIF [Sales] > 10000 THEN "Very High"  // Never reached!

‚úì Correct order:
IF [Sales] > 10000 THEN "Very High"
ELSEIF [Sales] > 1000 THEN "High"
```

---

### **Scenario-Based Questions:**

**Q1:** You need to categorize products: <$50 "Cheap", $50-$200 "Moderate", >$200 "Expensive". Best approach?
- A) Three separate calculated fields
- B) IF statement with ELSEIF ‚úÖ
- C) Three filters
- D) Groups

**Why?** Single calculated field with conditional logic creates categories. Groups combine existing categories; filters remove data.

---

**Q2:** This calculation errors: `IF [Region] = "West" THEN SUM([Sales]) ELSE 0 END`. Fix?
- A) Remove SUM
- B) Wrap entire IF in SUM ‚úÖ
- C) Use CASE instead
- D) Add END statement

**Why?** Can't mix row-level ([Region]) with aggregate (SUM). Solution: `SUM(IF [Region] = "West" THEN [Sales] ELSE 0 END)`

---

**Q3:** You have 20 product codes to categorize into 5 groups. Cleanest approach?
- A) Nested IF with 20 conditions
- B) CASE statement with WHEN conditions ‚úÖ
- C) 20 separate IIF statements
- D) Manual groups

**Why?** CASE cleanly handles multiple value-to-category mappings. Groups also work but calculated field is more flexible.

---

**Q4:** Calculate "Profitable" if Profit > 0, otherwise "Loss". Shortest syntax?
- A) `IF [Profit] > 0 THEN "Profitable" ELSE "Loss" END`
- B) `IIF([Profit] > 0, "Profitable", "Loss")` ‚úÖ
- C) `CASE WHEN [Profit] > 0 THEN "Profitable" ELSE "Loss" END`
- D) All equally short

**Why?** IIF is most concise for simple true/false. All work correctly though.

---

## **Topic 16: Aggregate vs Row-Level Calculations** ‚≠ê‚≠ê‚≠ê **EXAM CRITICAL!**

### **Understanding Calculation Types**

This is **THE MOST IMPORTANT** concept for exam MCQs about calculations!

**Two fundamental types:**
1. **Row-Level Calculations** - Calculated for each row, then aggregated in view
2. **Aggregate Calculations** - Data aggregated first, then calculated

---

### **Row-Level Calculations**

**Definition:** Calculation performed on **each individual row** of data before aggregation.

**Characteristics:**
- References fields WITHOUT aggregation functions
- Computed row-by-row
- Then Tableau aggregates results in view (SUM, AVG, etc.)
- Creates a new "column" in your data table (conceptually)

---

**Example 1: Profit per Unit (Row-Level)**
```
[Profit] / [Quantity]
```

**What happens:**
```
Row 1: Profit: 100, Qty: 10 ‚Üí 10 per unit
Row 2: Profit: 50, Qty: 5 ‚Üí 10 per unit
Row 3: Profit: 200, Qty: 25 ‚Üí 8 per unit

In view showing AVG:
AVG(10, 10, 8) = 9.33 per unit
```

---

**Example 2: Discount Amount (Row-Level)**
```
[Sales] * [Discount]
```

**What happens:**
```
Row 1: Sales: 100, Discount: 0.10 ‚Üí 10
Row 2: Sales: 200, Discount: 0.15 ‚Üí 30
Row 3: Sales: 150, Discount: 0.05 ‚Üí 7.50

In view showing SUM:
SUM(10, 30, 7.50) = 47.50 total discount
```

---

### **Aggregate Calculations**

**Definition:** Calculation performed on **aggregated data** in the view.

**Characteristics:**
- Uses aggregation functions (SUM, AVG, COUNT, etc.)
- Data grouped first by dimensions in view
- Then calculation performed
- No row-by-row computation

---

**Example 1: Overall Profit Margin (Aggregate)**
```
SUM([Profit]) / SUM([Sales])
```

**What happens:**
```
Row 1: Profit: 100, Sales: 500
Row 2: Profit: 50, Sales: 400
Row 3: Profit: 200, Sales: 1000

First: Aggregate
Total Profit = 100 + 50 + 200 = 350
Total Sales = 500 + 400 + 1000 = 1900

Then: Calculate
350 / 1900 = 18.4% margin
```

---

**Example 2: Sales Per Order (Aggregate)**
```
SUM([Sales]) / COUNTD([Order ID])
```

**What happens:**
```
First: Aggregate by dimensions in view (e.g., Region)
Region: East
  Total Sales = 50,000
  Unique Orders = 250

Then: Calculate
50,000 / 250 = $200 per order
```

---

### **The CRITICAL Difference** üéØ

**Same data, different approaches = different results!**

**Sample Data:**
```
Order | Sales | Profit
A     | 100   | 20
B     | 200   | 30
C     | 300   | 45
```

---

**Question: What's the profit margin?**

**Row-Level Approach:**
```
// Calculate margin for each order
[Profit] / [Sales]

Order A: 20/100 = 20%
Order B: 30/200 = 15%
Order C: 45/300 = 15%

If aggregated as AVG:
(20% + 15% + 15%) / 3 = 16.67%
```

---

**Aggregate Approach:**
```
SUM([Profit]) / SUM([Sales])

Total Profit: 20 + 30 + 45 = 95
Total Sales: 100 + 200 + 300 = 600

95 / 600 = 15.83%
```

---

**Different answers!** 16.67% vs 15.83%

**Which is "correct"?**
- **Aggregate (15.83%)** for overall business margin
- **Row-level averaged (16.67%)** for average order's margin

**Context matters!** Know what business question you're answering.

---

### **When Results Match vs Differ**

**They give SAME result when:**
- Using SUM on row-level calculation
- Linear operations (addition, subtraction)
- Each row weighted equally

**Example - Same Result:**
```
Row-level: [Sales] - [Cost]
Aggregate: SUM([Sales]) - SUM([Cost])

Row 1: 100 - 70 = 30
Row 2: 200 - 150 = 50
SUM = 80

Aggregate:
SUM(100, 200) - SUM(70, 150)
= 300 - 220 = 80

SAME! ‚úì
```

---

**They give DIFFERENT results when:**
- Using AVG, ratios, percentages
- Non-linear operations (division, multiplication)
- Rows have different weights/volumes

**Example - Different Result:**
```
Row-level: [Profit] / [Sales]
Aggregate: SUM([Profit]) / SUM([Sales])

As shown earlier: 16.67% vs 15.83%
DIFFERENT! ‚ö†Ô∏è
```

---

### **Real-World Example: Store Performance**

**Data:**
```
Store | Sales | Transactions
A     | 1000  | 10    ‚Üí $100 per transaction
B     | 500   | 50    ‚Üí $10 per transaction
```

---

**Question: Average sales per transaction?**

**Row-Level (Wrong for this question):**
```
[Sales] / [Transactions]

Store A: 100
Store B: 10
AVG: (100 + 10) / 2 = $55 per transaction
```

**Aggregate (Correct for overall metric):**
```
SUM([Sales]) / SUM([Transactions])

Total Sales: 1500
Total Transactions: 60
1500 / 60 = $25 per transaction
```

---

**Why different?**
- Row-level gives equal weight to each store (treats Store A and B equally)
- Aggregate weights by actual volume (Store A has 10 transactions, Store B has 50)

**Store B has more transactions, so pulls average down!**

---

### **Mixing Aggregate and Row-Level** ‚ùå

**You CANNOT mix in same calculation!**

```
‚ùå WRONG:
[Category] = "Furniture" AND SUM([Sales]) > 1000

‚ùå WRONG:
IF [Region] = "West" THEN SUM([Sales]) ELSE 0 END
```

**Error: "Cannot mix aggregate and non-aggregate arguments"**

---

**Solutions:**

**Solution 1: Make everything row-level, aggregate outside**
```
‚úì SUM(IF [Region] = "West" THEN [Sales] ELSE 0 END)
```

**Solution 2: Make everything aggregate**
```
‚úì Use filters or LOD expressions (Module 7)
```

---

### **Aggregating Row-Level Calculations**

**You can aggregate a row-level calc in the view:**

**Create row-level calculated field:**
```
Name: Profit Per Unit
Formula: [Profit] / [Quantity]
```

**In view, it appears as:**
- `SUM(Profit Per Unit)`
- `AVG(Profit Per Unit)`
- `MIN(Profit Per Unit)`
- etc.

**Tableau automatically offers aggregation options.**

---

### **Determining Calculation Type**

**How to identify:**

**Row-Level indicators:**
- No AGG functions in formula
- References like `[Field]` not `SUM([Field])`
- Can be used with any aggregation in view
- Icon in Data pane: `#` (number) or `Abc` (text)

**Aggregate indicators:**
- Contains SUM(), AVG(), COUNT(), etc.
- Already aggregated
- Usually shown as `AGG()` in view
- Icon in Data pane: `=` symbol

---

### **Practical Guidelines**

**Use Row-Level when:**
- ‚úÖ Transforming individual records
- ‚úÖ Need flexibility in aggregation (SUM, AVG, MIN, MAX)
- ‚úÖ Calculating per-transaction metrics
- ‚úÖ String manipulations, date extractions

**Examples:**
- Full Name: `[First] + " " + [Last]`
- Order Age: `DATEDIFF('day', [Order Date], TODAY())`
- Price Per Unit: `[Sales] / [Quantity]`

---

**Use Aggregate when:**
- ‚úÖ Need overall summary metrics
- ‚úÖ Ratios of totals
- ‚úÖ Comparing sums/averages
- ‚úÖ Measures that only make sense aggregated

**Examples:**
- Overall Margin: `SUM([Profit]) / SUM([Sales])`
- Market Share: `SUM([Sales]) / SUM([Total Market])`
- Average Order Value: `SUM([Sales]) / COUNTD([Order ID])`

---

### **The "Correct" Approach for Margins** ‚≠ê

**For PROFIT MARGIN specifically:**

**Business usually wants aggregate:**
```
‚úì SUM([Profit]) / SUM([Sales])
```
"What's our overall profitability?"

---

**Not row-level averaged:**
```
‚ùå AVG([Profit] / [Sales])
```
"What's the average order's margin?" (rarely asked)

---

**Why? Volume matters!**

```
Order 1: $10 sales, $5 profit = 50% margin
Order 2: $1000 sales, $200 profit = 20% margin

Row-level AVG: (50% + 20%) / 2 = 35%
Aggregate: (5 + 200) / (10 + 1000) = 20.3%

Aggregate (20.3%) is "true" business margin!
```

**Order 2 is 99% of sales volume, should dominate the metric.**

---

### **Advanced Example: Weighted vs Unweighted**

**Student Test Scores:**
```
Student | Test 1 Score | Test 1 Weight | Test 2 Score | Test 2 Weight
Alice   | 80           | 40%           | 90           | 60%
Bob     | 70           | 40%           | 85           | 60%
```

---

**Unweighted Average (Row-Level):**
```
AVG([Test 1 Score])
= (80 + 70) / 2 = 75
```

**Weighted Average (Aggregate):**
```
SUM([Test 1 Score] * [Test 1 Weight]) / SUM([Test 1 Weight])
= (80*0.4 + 70*0.4) / (0.4 + 0.4)
= 60 / 0.8 = 75
```
*In this case same because equal weights*

---

**But with different weights:**
```
Student | Score | Weight
Alice   | 90    | 0.7   (70% of grade)
Bob     | 60    | 0.3   (30% of grade)

Unweighted AVG: (90 + 60) / 2 = 75

Weighted (Aggregate):
(90*0.7 + 60*0.3) / (0.7 + 0.3)
= (63 + 18) / 1
= 81

Big difference! Aggregate reflects true weighted grade.
```

---

### **Scenario-Based Questions:**

**Q1:** You calculate profit margin as `[Profit]/[Sales]` and show AVG in view. Colleague calculates as `SUM([Profit])/SUM([Sales])`. Both show different results. Why?
- A) Data error
- B) First is row-level averaged, second is aggregate ‚úÖ
- C) Wrong aggregation type
- D) Need WINDOW_AVG

**Why?** Classic row-level vs aggregate difference. Row-level treats each order equally; aggregate weights by volume.

---

**Q2:** Which correctly calculates overall profit margin across all orders?
- A) `AVG([Profit] / [Sales])`
- B) `SUM([Profit]) / SUM([Sales])` ‚úÖ
- C) `[Profit] / [Sales]` aggregated as AVG
- D) `SUM([Profit] / [Sales])`

**Why?** Overall margin needs total profit divided by total sales (aggregate). Row-level approach gives equal weight to small and large orders.

---

**Q3:** This calculation errors: `IF [Category] = "Furniture" THEN SUM([Sales]) ELSE 0 END`. Why?
- A) Wrong IF syntax
- B) Mixing row-level and aggregate ‚úÖ
- C) Missing ELSE
- D) Category not in quotes

**Why?** `[Category]` is row-level, `SUM([Sales])` is aggregate. Can't mix. Fix: `SUM(IF [Category] = "Furniture" THEN [Sales] ELSE 0 END)`

---

**Q4:** You need flexibility to show profit margin as SUM, AVG, or MIN. Best approach?
- A) Create three separate calculated fields
- B) Create row-level calc `[Profit]/[Sales]`, aggregate in view ‚úÖ
- C) Create aggregate calc `SUM([Profit])/SUM([Sales])`
- D) Use parameter

**Why?** Row-level calc can be aggregated different ways in view. Aggregate calc locks you into one approach.

---

**Q5:** When do row-level and aggregate calculations give the same result?
- A) Never
- B) Always
- C) When using SUM on linear operations (addition/subtraction) ‚úÖ
- D) Only with AVG

**Why?** `SUM([A] + [B])` = `SUM([A]) + SUM([B])` but `AVG([A]/[B])` ‚â† `

# MODULE 4: Calculations (Continued)

---

## **Topic 16: Aggregate vs Row-Level Calculations** (Continued)

**Why?** `SUM([A] + [B])` = `SUM([A]) + SUM([B])` but `AVG([A]/[B])` ‚â† `AVG([A]) / AVG([B])`. Linear operations (add/subtract) distribute; ratios don't.

---

### **Practice Exercises**

**For each scenario, determine if you need row-level or aggregate:**

**Scenario 1:** Calculate shipping cost per item for each order
- **Answer:** Row-level `[Shipping Cost] / [Quantity]`
- **Why:** Need per-order calculation, then can aggregate various ways

**Scenario 2:** Calculate overall company profit margin
- **Answer:** Aggregate `SUM([Profit]) / SUM([Sales])`
- **Why:** Overall metric needs total profit √∑ total sales

**Scenario 3:** Calculate days between order and ship for each order
- **Answer:** Row-level `DATEDIFF('day', [Order Date], [Ship Date])`
- **Why:** Per-order metric, then analyze with AVG, MAX, etc.

**Scenario 4:** Calculate average order value by region
- **Answer:** Aggregate `SUM([Sales]) / COUNTD([Order ID])`
- **Why:** Regional total sales √∑ regional order count

**Scenario 5:** Create full customer name
- **Answer:** Row-level `[First Name] + " " + [Last Name]`
- **Why:** String operation on each customer record

**Scenario 6:** Calculate percentage each product contributes to category sales
- **Answer:** Aggregate (with LOD or Table Calc - Module 7)
- **Why:** Need product sales √∑ category total

---

### **Common Real-World Calculations**

**1. Customer Lifetime Value (Aggregate):**
```
SUM([Sales]) / COUNTD([Customer ID])
```
Total sales divided by unique customer count

---

**2. Items Per Order (Aggregate):**
```
SUM([Quantity]) / COUNTD([Order ID])
```
Total items divided by unique orders

---

**3. Conversion Rate (Aggregate):**
```
COUNTD([Purchases]) / COUNTD([Visits])
```
Unique purchases divided by unique visits

---

**4. Same-Store Sales Growth (Aggregate):**
```
(SUM([Sales This Year]) - SUM([Sales Last Year])) / SUM([Sales Last Year])
```
Year-over-year growth calculation

---

**5. Discount Impact (Row-Level):**
```
[Sales] * [Discount Percent]
```
Then: `SUM([Discount Impact])` in view

---

**6. Revenue Per Available Room - REVPAR (Aggregate):**
```
SUM([Room Revenue]) / SUM([Total Rooms])
```
Hotel industry metric

---

**7. Inventory Turnover (Aggregate):**
```
SUM([Cost of Goods Sold]) / AVG([Inventory Value])
```
How quickly inventory sells

---

### **Debugging Calculation Issues**

**Problem: "My calculation gives unexpected results"**

**Step 1: Check if row-level or aggregate**
```
Look for SUM(), AVG(), etc. in formula
```

**Step 2: Check granularity**
```
What dimensions are in your view?
More dimensions = more detail = different aggregation
```

**Step 3: Test with simple data**
```
Create small dataset, calculate manually
Compare to Tableau result
```

**Step 4: Break complex calculations into steps**
```
Instead of: SUM([A]) / SUM([B]) * SUM([C])
Create: 
  Step 1: [A Ratio] = SUM([A]) / SUM([B])
  Step 2: [Final] = [A Ratio] * SUM([C])
```

**Step 5: Check for NULLs**
```
Use IFNULL() or ZN() to handle missing data
```

---

### **Key Takeaways for Exam** üéØ

‚úÖ **Row-level** = Calculated per row, then aggregated in view

‚úÖ **Aggregate** = Data aggregated first, then calculated

‚úÖ **They differ** for ratios, averages, non-linear operations

‚úÖ **Cannot mix** row-level and aggregate in same calculation

‚úÖ **For overall margins/rates** ‚Üí Use aggregate approach

‚úÖ **For per-record calculations** ‚Üí Use row-level approach

‚úÖ **Granularity matters** ‚Üí Same calculation, different dimensions = different results

---

## **MODULE 4 SUMMARY: Calculations**

### **What We Covered:**

**Topic 13: Calculated Fields Basics**
- Creating calculated fields (row-level vs aggregate)
- Basic syntax and operators
- NULL handling
- Managing calculated fields

**Topic 14: String, Number & Date Functions**
- String manipulation (UPPER, SPLIT, TRIM, REPLACE, etc.)
- Math operations (ROUND, ABS, POWER, etc.)
- Date calculations (DATEDIFF, DATEADD, DATEPART, etc.)

**Topic 15: Logical Functions**
- IF statements (simple, nested, multiple conditions)
- CASE statements (simple and searched)
- Logical operators (AND, OR, NOT, IN)
- IIF() function
- Boolean logic

**Topic 16: Aggregate vs Row-Level**
- Understanding calculation types
- When results differ
- Mixing aggregate and row-level (can't do it!)
- Real-world applications

---

### **Critical Exam Concepts** üéØ

**1. Row-Level vs Aggregate**
- THE most important calculation concept
- Know when each gives different results
- Understand why margins/ratios differ

**2. Date Functions**
- DATEDIFF for calculating time between dates
- DATEADD for date arithmetic
- Date part extraction (YEAR, MONTH, etc.)

**3. Logical Functions**
- IF-ELSEIF-ELSE structure
- CASE for multiple values
- IN operator for lists

**4. Cannot Mix**
- Row-level and aggregate in same calculation
- Error: "Cannot mix aggregate and non-aggregate"
- Solution: Make all row-level or all aggregate

**5. NULL Handling**
- Use IFNULL(), ZN(), ISNULL()
- NULL in math = NULL result
- Check for NULL in comparisons

---

### **Common Exam Question Patterns**

**Pattern 1: "Why different results?"**
- Usually row-level vs aggregate issue
- Check what's being averaged/summed

**Pattern 2: "Fix this calculation error"**
- Usually mixing aggregate and row-level
- Or missing END statement

**Pattern 3: "Calculate [business metric]"**
- Determine if row-level or aggregate needed
- Choose appropriate functions

**Pattern 4: "Show only [condition]"**
- Use IF or CASE to create categories
- Or use as filter

**Pattern 5: "Date-based calculation"**
- DATEDIFF for duration
- DATEADD for future/past dates
- Date comparisons with TODAY()

---

### **Self-Check Questions**

**Before moving to Module 5, can you answer:**

1. What's the difference between `AVG([Profit]/[Sales])` and `SUM([Profit])/SUM([Sales])`?

2. How do you calculate number of days between Order Date and Ship Date?

3. What's wrong with: `IF [Region] = "West" THEN SUM([Sales]) ELSE 0 END`?

4. When would you use CASE instead of IF?

5. How do you handle NULL values in calculations?

6. What does `DATEDIFF('month', [Start], TODAY())` calculate?

7. How do you check if a product name contains "Pro" or "Premium"?

8. What's the difference between ROUND([Sales], 2) and ROUND([Sales], -2)?

---

### **Practice Challenge** üéØ

**Create these calculated fields in Tableau:**

**Easy:**
1. Customer age from birth date
2. Full address (Street + City + State)
3. Profit margin as percentage
4. Is order profitable? (TRUE/FALSE)

**Medium:**
5. Sales tier: <$10K "Small", $10-50K "Medium", >$50K "Large"
6. Days to ship, labeled as "Fast" (‚â§2), "Normal" (3-5), "Slow" (>5)
7. First name from "Last, First" format
8. Quarter label like "Q1 2023"

**Hard:**
9. Sales per customer by region (aggregate)
10. Percentage of orders that are profitable
11. Moving average calculation (we'll cover properly in Module 7)
12. Year-over-year sales growth percentage

---

### **Most Common Mistakes to Avoid** ‚ùå

1. **Mixing row-level and aggregate**
   - `IF [Field] THEN SUM([Other]) END` ‚ùå
   - Fix: Make both same type

2. **Wrong margin calculation**
   - `AVG([Profit]/[Sales])` for overall margin ‚ùå
   - Use: `SUM([Profit])/SUM([Sales])` ‚úì

3. **Forgetting END statement**
   - `IF [Condition] THEN "Yes"` ‚ùå
   - Add: `ELSE "No" END` ‚úì

4. **Case sensitivity in strings**
   - `[Category] = "furniture"` when data is "Furniture" ‚ùå
   - Use: `LOWER([Category]) = "furniture"` ‚úì

5. **Not handling NULLs**
   - `[Sales] + [Bonus]` when Bonus can be NULL ‚ùå
   - Use: `[Sales] + ZN([Bonus])` ‚úì

6. **Wrong ROUND decimals**
   - `ROUND([Sales], 100)` to round to hundreds ‚ùå
   - Use: `ROUND([Sales], -2)` ‚úì

7. **DATEDIFF parameter order**
   - `DATEDIFF('day', TODAY(), [Order Date])` ‚ùå (negative)
   - Use: `DATEDIFF('day', [Order Date], TODAY())` ‚úì

8. **Type mismatches**
   - `IF [Sales] > 1000 THEN "High" ELSE 0 END` ‚ùå
   - Keep types consistent ‚úì

---

## **Ready for Module 5: Advanced Visualizations?** üöÄ

Module 5 covers:
- Dual Axis & Combined Charts
- Reference Lines & Trend Lines
- Parameters (HUGE for exams!)
- Actions (Filter, Highlight, URL)

**Module 5 is where Tableau gets really powerful and interactive!**

Parameters especially are featured heavily in scenario-based MCQs because they enable dynamic, user-controlled visualizations.

---

**Type "Module 5" when ready to continue!**

Or let me know if you want to:
- Review any calculation concepts
- See more practice problems
- Work through specific scenarios
- Take a break and resume later

**Pro tip:** Before moving on, open Tableau and try creating 3-4 of the practice calculations above. Hands-on practice solidifies these concepts! üí™
